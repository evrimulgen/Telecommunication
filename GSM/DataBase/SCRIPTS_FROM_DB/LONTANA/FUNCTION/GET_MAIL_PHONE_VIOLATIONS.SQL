
  CREATE OR REPLACE FUNCTION "LONTANA"."GET_MAIL_PHONE_VIOLATIONS" (
  pYEAR_MONTH IN INTEGER
  ) RETURN CLOB IS
--Version#1
RESULT_CLOB CLOB;
LINE CLOB;
BEGIN
--  DBMS_LOB.CREATETEMPORARY(RESULT_CLOB, TRUE);
  RESULT_CLOB:='"Телефон"' || CHR(9) || '"Сумма"';  
  FOR rec IN(
    SELECT PHONE_NUMBER, ESTIMATE_SUM
      FROM V_PHONE_NUMBER_VIOLATIONS
      WHERE YEAR_MONTH=pYEAR_MONTH
      ORDER BY ESTIMATE_SUM DESC
  ) LOOP
    LINE:=CHR(10) || rec.PHONE_NUMBER || CHR(9) || TO_CHAR(rec.ESTIMATE_SUM) || 'р';
    DBMS_LOB.APPEND(RESULT_CLOB, LINE);      
  END LOOP;       
  RETURN RESULT_CLOB;
  DBMS_LOB.FREETEMPORARY(RESULT_CLOB); 
END; 