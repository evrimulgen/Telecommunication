
  CREATE OR REPLACE FUNCTION "LONTANA"."NEW_SUBSCRIBE_PAY" (
  pPHONE_NUMBER IN VARCHAR2,
  pADD_COST IN INTEGER,
  pYEAR_MONTH IN INTEGER
  ) RETURN NUMBER IS
--
--Vresion=1
--
--12.10.2011 Крайнов. Создание.
ADD_COST NUMBER(12, 2); 
ITOG NUMBER(12, 2);   
MONTH_BEGIN DATE;
MONTH_END DATE;
COUNT_DAYS INTEGER;
LAST_DAY_PERIOD DATE;
BEGIN
  ITOG:=0;
  MONTH_BEGIN:=TRUNC(TO_DATE(TO_CHAR(pYEAR_MONTH)||'01','YYYYMMDD'));
  MONTH_END:=TRUNC(LAST_DAY(MONTH_BEGIN));
  COUNT_DAYS:=0;
  LAST_DAY_PERIOD:=TRUNC(TO_DATE('19861124','YYYYMMDD'));
  FOR rec IN(
    SELECT DB_LOADER_ACCOUNT_PHONE_HISTS.BEGIN_DATE,
           DB_LOADER_ACCOUNT_PHONE_HISTS.END_DATE
      FROM DB_LOADER_ACCOUNT_PHONE_HISTS
      WHERE DB_LOADER_ACCOUNT_PHONE_HISTS.PHONE_NUMBER=pPHONE_NUMBER
        AND DB_LOADER_ACCOUNT_PHONE_HISTS.PHONE_IS_ACTIVE=1
        AND DB_LOADER_ACCOUNT_PHONE_HISTS.BEGIN_DATE<=MONTH_END
        AND DB_LOADER_ACCOUNT_PHONE_HISTS.END_DATE>=MONTH_BEGIN
    )
  LOOP
    IF rec.BEGIN_DATE<MONTH_BEGIN THEN
      rec.BEGIN_DATE:=MONTH_BEGIN;
    END IF;
    IF rec.END_DATE<MONTH_END THEN
      rec.END_DATE:=MONTH_END;
    END IF;    
    COUNT_DAYS:=COUNT_DAYS+TRUNC(rec.END_DATE-rec.BEGIN_DATE+1);
    IF TRUNC(rec.BEGIN_DATE)=LAST_DAY_PERIOD THEN
      COUNT_DAYS:=COUNT_DAYS-1;
    END IF;    
    LAST_DAY_PERIOD:=TRUNC(rec.END_DATE);
  END LOOP;
  ITOG:=pADD_COST*COUNT_DAYS/(MONTH_END-MONTH_BEGIN+1);   
  RETURN ITOG;
END; 