
  CREATE OR REPLACE FUNCTION "LONTANA"."WWW_SET_USER_PASSWORD" (
  pPHONE_NUMBER IN VARCHAR2 
  ) RETURN VARCHAR2 IS
--  
--#Version=2
--
-- 2 Крайнов. Добавил учет числа попыток.
--
CURSOR C IS
  SELECT CONTRACTS.CONTRACT_ID,
         CONTRACTS.DATE_LAST_SET_PASS,
         CONTRACTS.COUNT_SET_PASS_BY_DAY
    FROM CONTRACTS
    WHERE PHONE_NUMBER_FEDERAL=pPHONE_NUMBER 
    ORDER BY CONTRACTS.CONTRACT_DATE DESC
    ;
vREC C%ROWTYPE;   
PASSW VARCHAR2(20 CHAR);  
SET_PASS BOOLEAN;
ITOG VARCHAR2(20 CHAR); 
BEGIN
  IF (pPHONE_NUMBER<>'9671875423')
      OR (pPHONE_NUMBER<>'9688656669')
      OR (pPHONE_NUMBER<>'9652052000') THEN
    SET_PASS:=FALSE;
    OPEN C;
    FETCH C INTO vREC;
    CLOSE C;
    PASSW:=TO_CHAR(TRUNC(DBMS_RANDOM.VALUE(100000,999999)));  
    IF TO_CHAR(vREC.DATE_LAST_SET_PASS,'YYYYMMDD')=TO_CHAR(SYSDATE,'YYYYMMDD') THEN
      UPDATE CONTRACTS 
        SET COUNT_SET_PASS_BY_DAY=vREC.COUNT_SET_PASS_BY_DAY+1
        WHERE CONTRACT_ID=vREC.CONTRACT_ID;
      IF vREC.COUNT_SET_PASS_BY_DAY<3 THEN
        SET_PASS:=TRUE;
      END IF;
    ELSE
      UPDATE CONTRACTS 
        SET COUNT_SET_PASS_BY_DAY=1,
            DATE_LAST_SET_PASS=SYSDATE
        WHERE CONTRACT_ID=vREC.CONTRACT_ID; 
      SET_PASS:=TRUE;
    END IF;
    IF (pPHONE_NUMBER='9671875423')
      OR (pPHONE_NUMBER='9688656669')
      OR (pPHONE_NUMBER='9645780578')
      OR (pPHONE_NUMBER='9654431122')
      OR (pPHONE_NUMBER='9652555501') THEN
        SET_PASS:=FALSE;
    END IF;  
    IF SET_PASS THEN
      UPDATE CONTRACTS 
        SET USER_PASSWORD=PASSW
        WHERE CONTRACT_ID=vREC.CONTRACT_ID;
      RETURN PASSW;
    ELSE
      ITOG:='Ошибка доступа';
      RETURN ITOG;
    END IF; 
  ELSE
    ITOG:='Ошибка доступа';
    RETURN ITOG; 
  END IF;  
END;