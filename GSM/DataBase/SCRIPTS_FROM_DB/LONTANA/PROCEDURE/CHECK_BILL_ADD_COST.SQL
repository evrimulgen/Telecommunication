
  CREATE OR REPLACE PROCEDURE "LONTANA"."CHECK_BILL_ADD_COST" IS
  -- Version = 1
  CURSOR C(pACCOUNT_ID IN INTEGER, pYEAR_MONTH IN INTEGER, pPHONE_NUMBER IN VARCHAR2) IS
    SELECT *
      FROM BILL_RECALC_ADD_COST
      WHERE ACCOUNT_ID = pACCOUNT_ID
        AND YEAR_MONTH = pYEAR_MONTH
        AND PHONE_NUMBER = pPHONE_NUMBER;
  DUMMY C%ROWTYPE;
  vYEAR_MONTH INTEGER;
  vCHECK VARCHAR2(500 CHAR);
  vCHECK1 VARCHAR2(500 CHAR);
  vCHECK2 VARCHAR2(500 CHAR);
  vALL NUMBER(15, 4);
  vCALL NUMBER(15, 4);
  vSMS NUMBER(15, 4);
  i integer;
  j integer;
  l integer;
  vWRITE_ITOG INTEGER;
BEGIN
  vYEAR_MONTH:=TO_NUMBER(TO_CHAR(ADD_MONTHS(SYSDATE, -1), 'YYYYMM'));
  FOR rec IN (SELECT FB.*
                FROM DB_LOADER_FULL_FINANCE_BILL FB
                WHERE FB.YEAR_MONTH = vYEAR_MONTH
                  AND FB.COMPLETE_BILL = 1
                  AND FB.BILL_SUM > 0 
                  AND FB.ACCOUNT_ID = 185)
  LOOP
    vCHECK:=LOADER3_PCKG.GET_ADD_DETAIL_COST(TRUNC(vYEAR_MONTH/100), vYEAR_MONTH-TRUNC(vYEAR_MONTH/100)*100, rec.PHONE_NUMBER);
    --  DBMS_OUTPUT.PUT_LINE(vCHECK);
    IF LENGTH(vCHECK) < 4 THEN
      vCHECK:='All:0;Call:0;SMS:0';
    END IF;
    IF INSTR(vCHECK, 'All', 4) > 0 THEN
      vCHECK1:=SUBSTR(vCHECK, 1, INSTR(vCHECK, 'All', 4)-1);
      vCHECK2:=SUBSTR(vCHECK, INSTR(vCHECK, 'All', 4));
    ELSE 
      vCHECK1:=vCHECK;
      vCHECK2:='All:0;Call:0;SMS:0';
    END IF;
    begin
      vALL:=TO_NUMBER(SUBSTR(vCHECK1, 1+INSTR(vCHECK1, ':', 1, 1), INSTR(vCHECK1, ';', 1, 1)-INSTR(vCHECK1, ':', 1, 1)-1))
          + TO_NUMBER(SUBSTR(vCHECK2, 1+INSTR(vCHECK2, ':', 1, 1), INSTR(vCHECK2, ';', 1, 1)-INSTR(vCHECK2, ':', 1, 1)-1));
      vCALL:=TO_NUMBER(SUBSTR(vCHECK1, 1+INSTR(vCHECK1, ':', 1, 2), INSTR(vCHECK1, ';', 1, 2)-INSTR(vCHECK1, ':', 1, 2)-1))
           + TO_NUMBER(SUBSTR(vCHECK2, 1+INSTR(vCHECK2, ':', 1, 2), INSTR(vCHECK2, ';', 1, 2)-INSTR(vCHECK2, ':', 1, 2)-1));
      vSMS:=TO_NUMBER(SUBSTR(vCHECK1, 1+INSTR(vCHECK1, ':', 1, 3))) + TO_NUMBER(SUBSTR(vCHECK2, 1+INSTR(vCHECK2, ':', 1, 3)));
      vWRITE_ITOG:=1;
    exception
      WHEN OTHERS THEN
      inseRt into temp12(STR1, STR2, STR3)
        values(vCHECK||'('||rec.PHONE_NUMBER||')', vCHECK1, vCHECK2);
      vWRITE_ITOG:=0;        
    end;
    /*  DBMS_OUTPUT.PUT_LINE(rec.ACCOUNT_ID);
      DBMS_OUTPUT.PUT_LINE(rec.YEAR_MONTH);
      DBMS_OUTPUT.PUT_LINE(rec.PHONE_NUMBER);
      DBMS_OUTPUT.PUT_LINE(vALL);
      DBMS_OUTPUT.PUT_LINE(vCALL);
      DBMS_OUTPUT.PUT_LINE(vSMS);*/
    IF vWRITE_ITOG=1 THEN  
      OPEN C(rec.ACCOUNT_ID, rec.YEAR_MONTH, rec.PHONE_NUMBER);
      FETCH C INTO DUMMY;
      IF C%FOUND THEN
        UPDATE BILL_RECALC_ADD_COST BR
          SET BR.CALLS_ALL = vALL, BR.CALLS = vCALL, BR.SMS = vSMS
          WHERE BR.ACCOUNT_ID = rec.ACCOUNT_ID
            AND BR.YEAR_MONTH = rec.YEAR_MONTH
            AND BR.PHONE_NUMBER = rec.PHONE_NUMBER;
      ELSE
        INSERT INTO BILL_RECALC_ADD_COST(ACCOUNT_ID, YEAR_MONTH, PHONE_NUMBER, CALLS_ALL, CALLS, SMS)
                      VALUES(rec.ACCOUNT_ID, rec.YEAR_MONTH, rec.PHONE_NUMBER, vALL,      vCALL, vSMS);
      END IF;
      CLOSE C;
      COMMIT;
    END IF;
  END LOOP; 
END; 