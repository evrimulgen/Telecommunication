
  CREATE OR REPLACE PROCEDURE "LONTANA"."CRM_UPDATE_REQUEST" 
(
  pREQUEST_ID IN INTEGER,
  pTEXT_REQUEST IN LONG DEFAULT NULL, 
  pOPerator IN VARCHAR2 DEFAULT NULL, 
  pID_STATUS_REQUEST IN INTEGER DEFAULT NULL, 
  pRESPONSIBLE_USER IN VARCHAR2 DEFAULT NULL,
  pTYPE_REQUEST_ID IN INTEGER DEFAULT NULL,
  pDOP_CONTACT IN VARCHAR2 DEFAULT NULL,
  pATTACHED_FILES IN VARCHAR2 DEFAULT NULL,
  pDEADLINE_DATE IN VARCHAR2 DEFAULT NULL
  )
IS
--#Version=1
  vRES NUMBER;
  SMS        VARCHAR2(2000);
  NEEDTOUPDATE int;
BEGIN
  IF pTEXT_REQUEST IS NULL AND pID_STATUS_REQUEST IS NOT NULL THEN 
   update CRM_REQUESTS set USER_LAST_UPDATED=pOPerator, ID_STATUS_REQUEST= pID_STATUS_REQUEST where REQUEST_ID=pREQUEST_ID;
  END IF;
  IF pTEXT_REQUEST IS NOT NULL AND pID_STATUS_REQUEST IS NULL THEN 
   update CRM_REQUESTS set TEXT_REQUEST=pTEXT_REQUEST, USER_LAST_UPDATED=pOPerator where REQUEST_ID=pREQUEST_ID;
  END IF;
  IF pTEXT_REQUEST IS NOT NULL AND pID_STATUS_REQUEST IS NOT NULL THEN 
   update CRM_REQUESTS set TEXT_REQUEST=pTEXT_REQUEST, USER_LAST_UPDATED=pOPerator, ID_STATUS_REQUEST= pID_STATUS_REQUEST where REQUEST_ID=pREQUEST_ID;
  END IF;
  IF pRESPONSIBLE_USER IS NOT NULL THEN 
   update CRM_REQUESTS set RESPONSIBLE_USER=pRESPONSIBLE_USER where REQUEST_ID=pREQUEST_ID;
  END IF;
  IF pTYPE_REQUEST_ID IS NOT NULL THEN 
   update CRM_REQUESTS set TYPE_REQUEST_ID=pTYPE_REQUEST_ID where REQUEST_ID=pREQUEST_ID;
  END IF;
  IF pDOP_CONTACT IS NOT NULL THEN 
   IF pDOP_CONTACT<>'NULL' THEN
    update CRM_REQUESTS set DOP_CONTACT=pDOP_CONTACT where REQUEST_ID=pREQUEST_ID;
   ELSE 
    update CRM_REQUESTS set DOP_CONTACT=NULL where REQUEST_ID=pREQUEST_ID;
   END IF;
  END IF;
  IF pID_STATUS_REQUEST=4 then     
   INSERT INTO CRM_EVENTS (REQUEST_ID, EVENT_PATH, USER_LAST_UPDATED) VALUES (pREQUEST_ID, 'REQUESTS\CLOSE', pOPerator);
   IF MS_params.GET_PARAM_VALUE('SEND_SMS_CREATE_REQUEST')='1' THEN
    SMS := LOADER3_pckg.SEND_SMS('9276561268',
                              'Заявка',
                              'Ваша заявка №'|| to_char(pREQUEST_ID) ||', выполнена. ');
   END IF;
  ELSE 
   NEEDTOUPDATE:=0;
   BEGIN
     SELECT EVENT_ID INTO NEEDTOUPDATE FROM CRM_EVENTS WHERE REQUEST_ID=pREQUEST_ID AND EVENT_PATH='REQUESTS\CHANGE' AND DATE_LAST_UPDATED=(SELECT MAX(DATE_LAST_UPDATED) FROM CRM_EVENTS WHERE REQUEST_ID=pREQUEST_ID) AND USER_LAST_UPDATED=pOPerator;
   EXCEPTION 
     WHEN NO_DATA_FOUND THEN NULL;
   END;
   IF NEEDTOUPDATE=0 THEN
     INSERT INTO CRM_EVENTS (REQUEST_ID, EVENT_PATH, USER_LAST_UPDATED) VALUES (pREQUEST_ID, 'REQUESTS\CHANGE', pOPerator);
   ELSE 
     UPDATE CRM_EVENTS SET DATE_LAST_UPDATED=SYSDATE WHERE EVENT_ID=NEEDTOUPDATE;
   END IF;
  END IF;
  IF pATTACHED_FILES IS NOT NULL THEN
    IF pATTACHED_FILES <> 'NULL' then 
      update CRM_REQUESTS set ATTACHED_FILES=pATTACHED_FILES where REQUEST_ID=pREQUEST_ID;
    ELSE
      update CRM_REQUESTS set ATTACHED_FILES=NULL where REQUEST_ID=pREQUEST_ID;
    END IF;  
  END IF;
  IF pDEADLINE_DATE IS NOT NULL THEN 
    IF pDEADLINE_DATE='NULL' THEN 
     update CRM_REQUESTS set DEADLINE_DATE=NULL where REQUEST_ID=pREQUEST_ID;
    ELSE
     update CRM_REQUESTS set DEADLINE_DATE=TO_DATE(pDEADLINE_DATE, 'YYYY.MM.DD HH24:MI:SS') where REQUEST_ID=pREQUEST_ID;
    END IF;
  END IF;
  commit;
END;