
  CREATE OR REPLACE TRIGGER "LONTANA"."TIU_CONTRACT_CHANGES" 
BEFORE INSERT OR UPDATE
ON CONTRACT_CHANGES
REFERENCING NEW AS NEW OLD AS OLD
FOR EACH ROW
DECLARE
CURSOR C IS
  SELECT DB_LOADER_ACCOUNT_PHONE_HISTS.*
    FROM DB_LOADER_ACCOUNT_PHONE_HISTS,
         CONTRACTS
    WHERE DB_LOADER_ACCOUNT_PHONE_HISTS.PHONE_NUMBER=CONTRACTS.PHONE_NUMBER_FEDERAL
      AND CONTRACTS.CONTRACT_ID=:NEW.CONTRACT_ID
    ORDER BY DB_LOADER_ACCOUNT_PHONE_HISTS.END_DATE DESC;
  rec C%ROWTYPE;    
  DATE_NOW DATE;
  vPHONE_NUMBER VARCHAR2(10 CHAR);
  vSTART INTEGER;
  vEND INTEGER;
  I INTEGER;
  J INTEGER;
BEGIN
  SELECT C.PHONE_NUMBER_FEDERAL INTO vPHONE_NUMBER
    FROM CONTRACTS C
    WHERE C.CONTRACT_ID = :NEW.CONTRACT_ID; 
  IF INSERTING THEN
    -- Прерывание в истории для создания разрыва отрезка времени (особенно актуально для одноосновных тарифов)
    OPEN C;
    FETCH C INTO rec;
    IF C%FOUND THEN
      DATE_NOW:=SYSDATE;
      UPDATE DB_LOADER_ACCOUNT_PHONE_HISTS
        SET DB_LOADER_ACCOUNT_PHONE_HISTS.END_DATE=DATE_NOW
        WHERE DB_LOADER_ACCOUNT_PHONE_HISTS.HISTORY_ID=rec.HISTORY_ID;
      INSERT INTO DB_LOADER_ACCOUNT_PHONE_HISTS(PHONE_NUMBER, BEGIN_DATE, END_DATE,PHONE_IS_ACTIVE, CELL_PLAN_CODE)
        VALUES(rec.PHONE_NUMBER, DATE_NOW, rec.END_DATE, rec.PHONE_IS_ACTIVE, rec.CELL_PLAN_CODE);
      INSERT INTO PHONES_TARIF_FOR_RECALC (PHONE_NUMBER) VALUES (rec.PHONE_NUMBER);
    END IF;
    CLOSE C;
    -- Новые параметры по умолчанию
    IF NVL(:NEW.CONTRACT_CHANGE_ID, 0) = 0 then
      :NEW.CONTRACT_CHANGE_ID := NEW_CONTRACT_CHANGE_ID;
    END IF;
    :NEW.USER_CREATED := USER;
    :NEW.DATE_CREATED := SYSDATE;
  END IF;   
  vSTART:=TO_NUMBER(TO_CHAR(:NEW.CONTRACT_CHANGE_DATE, 'YYYYMM'));
  vEND:=TO_NUMBER(TO_CHAR(SYSDATE, 'YYYYMM'));
  FOR I IN TRUNC(vSTART/100)..TRUNC(vEND/100) 
  LOOP
    FOR J IN 1..12 
    LOOP
      IF (I*100 + J >= vSTART) AND (I*100 + J <= vEND) THEN
        INSERT INTO QUEUE_ABONENT_PER_REBILD(YEAR_MONTH, PHONE_NUMBER)
          VALUES(I*100 + J, vPHONE_NUMBER);
      END IF;
    END LOOP;
  END LOOP;
  :NEW.USER_LAST_UPDATED := USER;
  :NEW.DATE_LAST_UPDATED := SYSDATE;
END; 
ALTER TRIGGER "LONTANA"."TIU_CONTRACT_CHANGES" ENABLE