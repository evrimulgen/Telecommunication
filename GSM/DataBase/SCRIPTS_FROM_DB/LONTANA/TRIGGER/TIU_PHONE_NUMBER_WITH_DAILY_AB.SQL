
  CREATE OR REPLACE TRIGGER "LONTANA"."TIU_PHONE_NUMBER_WITH_DAILY_AB" 
  BEFORE INSERT OR UPDATE ON LONTANA.PHONE_NUMBER_WITH_DAILY_ABON FOR EACH ROW
DECLARE
--Version=2. 
-- v2 - 02.11.2015 - Матюнин И. - Добавил логирование снятия, установки и обнвления посуточного списания (для последующего разбора, а то само слетает)  
  CURSOR C(pPHONE IN VARCHAR2) IS
    SELECT C.DAILY_ABON_BANNED
      FROM CONTRACTS C
      WHERE C.PHONE_NUMBER_FEDERAL = pPHONE
        AND NOT EXISTS (SELECT 1
                          FROM CONTRACT_CANCELS CC
                          WHERE CC.CONTRACT_ID = C.CONTRACT_ID);
    DUMMY C%ROWTYPE;
BEGIN
  :NEW.USER_LAST_UPDATE:=USER;
  :NEW.DATE_LAST_UPDATE:=SYSDATE;  
  OPEN C(:NEW.PHONE_NUMBER);
  FETCH C INTO DUMMY;
  IF C%FOUND THEN
    IF NVL(DUMMY.DAILY_ABON_BANNED, 0) = 1 THEN
      :NEW.PHONE_NUMBER:='0000000000';
    END IF;
  END IF;
  
  IF INSERTING THEN
    INSERT INTO PHN_NUMBER_WITH_DAILY_ABON_LOG(PHONE_NUMBER, ACTION_TYPE) values (:NEW.PHONE_NUMBER, 'INSERT. Установлено посуточное списание');  
  ELSE
    INSERT INTO PHN_NUMBER_WITH_DAILY_ABON_LOG(PHONE_NUMBER, ACTION_TYPE) values (:NEW.PHONE_NUMBER, 'UPDATE. Обновлено посуточное списание');         
  END IF;
END;
ALTER TRIGGER "LONTANA"."TIU_PHONE_NUMBER_WITH_DAILY_AB" ENABLE