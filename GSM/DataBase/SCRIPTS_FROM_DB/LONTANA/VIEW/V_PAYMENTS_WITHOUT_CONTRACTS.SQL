
  CREATE OR REPLACE FORCE VIEW "LONTANA"."V_PAYMENTS_WITHOUT_CONTRACTS" ("ACCOUNT_ID", "YEAR_MONTH", "PHONE_NUMBER", "PAYMENT_DATE", "PAYMENT_SUM", "PAYMENT_STATUS_IS_VALID", "PAYMENT_NUMBER", "PAYMENT_STATUS_TEXT", "CONTRACT_ID", "DATE_CREATED", "CONTRACT_DATE", "TARIFF_CODE") AS 
  SELECT P."ACCOUNT_ID",P."YEAR_MONTH",P."PHONE_NUMBER",P."PAYMENT_DATE",P."PAYMENT_SUM",P."PAYMENT_STATUS_IS_VALID",P."PAYMENT_NUMBER",P."PAYMENT_STATUS_TEXT",P."CONTRACT_ID",P."DATE_CREATED",
         (SELECT MAX(C.CONTRACT_DATE)
            FROM CONTRACTS C
            WHERE C.PHONE_NUMBER_FEDERAL=P.PHONE_NUMBER
              AND C.CONTRACT_ID NOT IN (
                    SELECT CC.CONTRACT_ID
                     FROM CONTRACT_CANCELS CC
                   )) CONTRACT_DATE,
         (SELECT AP.CELL_PLAN_CODE
            FROM DB_LOADER_ACCOUNT_PHONES AP
            WHERE AP.PHONE_NUMBER = P.PHONE_NUMBER
              AND AP.YEAR_MONTH = (SELECT MAX(AP2.YEAR_MONTH)
                                     FROM DB_LOADER_ACCOUNT_PHONES AP2
                                     WHERE AP2.PHONE_NUMBER = AP.PHONE_NUMBER)
              AND ROWNUM = 1) TARIFF_CODE                                
    FROM DB_LOADER_PAYMENTS P
    WHERE P.PAYMENT_DATE>=SYSDATE-4
      AND (P.PHONE_NUMBER NOT IN (
             SELECT C.PHONE_NUMBER_FEDERAL
               FROM CONTRACTS C
               WHERE C.CONTRACT_ID NOT IN (
                       SELECT CC.CONTRACT_ID
                         FROM CONTRACT_CANCELS CC))
        OR P.PHONE_NUMBER IN (
             SELECT PH.PHONE_NUMBER
               FROM DB_LOADER_ACCOUNT_PHONES PH
               WHERE PH.CONSERVATION=1
                 AND PH.LAST_CHECK_DATE_TIME>P.PAYMENT_DATE
                 AND PH.PHONE_NUMBER IN (
                       SELECT C1.PHONE_NUMBER_FEDERAL
                         FROM CONTRACTS C1
                         WHERE C1.CONTRACT_DATE>SYSDATE-4))
          ) 