CREATE OR REPLACE PROCEDURE GET_USER_ID(
  X_USERNAME IN VARCHAR2,
  X_PASSWORD IN VARCHAR2,
  SESSION_ID IN VARCHAR2,
  CLOSE_SESSION IN VARCHAR2
  ) IS
--
  vSESSION_ID VARCHAR2(200);
  vERROR_CODE BINARY_INTEGER;
--  vERROR_MESSAGE VARCHAR2(2000 CHAR);
BEGIN
  IF CLOSE_SESSION IS NULL THEN
    vSESSION_ID := SESSION_ID;
    IF (vSESSION_ID IS NULL) AND (X_USERNAME IS NOT NULL) THEN
      /*if (LENGTH(X_USERNAME) <> 10) then
        G_STATE.LOGIN_ERROR_TEXT := 'Неправильный номер телефона';
      ELS */
        IF X_PASSWORD IS NULL then
          G_STATE.LOGIN_ERROR_TEXT := 'Нужно указать пароль';
        END IF;
        IF G_STATE.LOGIN_ERROR_TEXT IS NULL THEN
          MF_REGISTER_SESSION(X_USERNAME, X_PASSWORD, vSESSION_ID, vERROR_CODE, G_STATE.LOGIN_ERROR_TEXT, G_STATE.USER_ID, G_STATE.IS_ADMIN);
          IF G_STATE.USER_ID IS NOT NULL THEN
            G_STATE.TITLE := 'Приветствуем вас!';
          ELSE
            G_STATE.TITLE := 'Ошибка входа. ' || G_STATE.LOGIN_ERROR_TEXT;
          END IF;
        ELSE
          G_STATE.TITLE:=G_STATE.LOGIN_ERROR_TEXT;
        END IF;
    END IF;
    IF vSESSION_ID IS NOT NULL THEN
      IF G_STATE.USER_ID IS NULL THEN
        MF_CHECK_SESSION_ID(vSESSION_ID, G_STATE.USER_ID, G_STATE.IS_ADMIN, G_STATE.PREV_ACCESS_DATE_TIME);
      END IF;
      
      IF G_STATE.USER_ID IS NULL THEN
        G_STATE.LOGIN_ERROR_TEXT := 'Неверные атрибуты сессии. Необходимо повторить вход в систему.';
        G_STATE.USER_ID := NULL;
      ELSIF G_STATE.USER_ID = 0 THEN
        G_STATE.LOGIN_ERROR_TEXT := 'Сессия устарела. Необходимо повторить вход в систему.';
        G_STATE.USER_ID := NULL;
      END IF;
    END IF;
  ELSE
    IF SESSION_ID IS NOT NULL THEN
      MF_CLOSE_SESSION(SESSION_ID);
    END IF;
  END IF;
  G_STATE.SESSION_ID := vSESSION_ID;
  IF vSESSION_ID IS NOT NULL THEN
    G_STATE.SESSION_KEY_PARAM_1 := 'SESSION_ID=' || vSESSION_ID;
    G_STATE.SESSION_KEY_PARAM_2 := '&amp;'||'SESSION_ID=' || vSESSION_ID;
  END IF;
END;
/

