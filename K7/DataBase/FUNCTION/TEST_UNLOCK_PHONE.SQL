CREATE OR REPLACE FUNCTION TEST_UNLOCK_PHONE(
    pPHONE_NUMBER IN VARCHAR2
   ) RETURN VARCHAR2 IS

  --   
vUNLOCK_RESULT VARCHAR2(2000);
vPHONE_NUMBER VARCHAR(10);

BEGIN
    vPHONE_NUMBER := '0';
    
    BEGIN
        SELECT V_PHONE_NUMBERS_FOR_UNLOCK.PHONE_NUMBER_FEDERAL INTO vPHONE_NUMBER
           FROM V_PHONE_NUMBERS_FOR_UNLOCK
        WHERE V_PHONE_NUMBERS_FOR_UNLOCK.PHONE_NUMBER_FEDERAL=pPHONE_NUMBER
          AND V_PHONE_NUMBERS_FOR_UNLOCK.HAND_BLOCK<>1
          AND NOT EXISTS(SELECT 1
                           FROM AUTO_UNBLOCKED_PHONE
                           WHERE V_PHONE_NUMBERS_FOR_UNLOCK.PHONE_NUMBER_FEDERAL=AUTO_UNBLOCKED_PHONE.PHONE_NUMBER
                             AND AUTO_UNBLOCKED_PHONE.NOTE='Ошибка. Error! Разблокировка через сайт не разрешена'
                             AND AUTO_UNBLOCKED_PHONE.UNBLOCK_DATE_TIME>SYSDATE-4/24) 
                                 --Номера с запретом не чаще раз в 4 часа
        order by BALANCE-NVL(DISCONNECT_LIMIT, 0) DESC;
    EXCEPTION WHEN NO_DATA_FOUND THEN
        vPHONE_NUMBER := '0';
    END;

   IF vPHONE_NUMBER <> '0' THEN
        BEGIN
        --vUNLOCK_RESULT := LOADER3_pckg.UNLOCK_PHONE(pPHONE_NUMBER, 0);
           INSERT INTO TEST_UNLOCK_TABLE (PHONE_NUMBER, DATE_CREATION, USER_CREATION) VALUES (vPHONE_NUMBER, SYSDATE, USER);
           vUNLOCK_RESULT := '';
           COMMIT;
           RETURN vUNLOCK_RESULT;
        END;   
    --ELSE 
       -- INSERT INTO TEST_UNLOCK_TABLE (PHONE_NUMBER, DATE_CREATION, USER_CREATION) VALUES ('тЕСТ', SYSDATE, USER);--уДАЛИТЬ ПОСЛЕ ТЕСТА
       -- DBMS_OUTPUT.PUT_LINE('1');
        --COMMIT;
        --RETURN vPHONE_NUMBER || ' не найден в базе данных.'; 
    END IF;
     
END;
/
