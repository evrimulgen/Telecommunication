
  CREATE OR REPLACE FUNCTION "CORP_MOBILE"."GET_ABONENT_BALANCE78" (
  pPHONE_NUMBER IN VARCHAR2,
  pBALANCE_DATE IN DATE DEFAULT NULL,
  pIOT_BALANCE IN VARCHAR2 DEFAULT null
  ) RETURN NUMBER IS
--#Version=3
  PRAGMA AUTONOMOUS_TRANSACTION;
  DATE_ROWS DBMS_SQL.DATE_TABLE;
  COST_ROWS DBMS_SQL.NUMBER_TABLE;
  DESCRIPTION_ROWS DBMS_SQL.VARCHAR2_TABLE;
  vRESULT NUMBER(15, 2);
  L BINARY_INTEGER;
  vBALANCE_DATE DATE;
BEGIN
  vRESULT := 0;
  vBALANCE_DATE:=pBALANCE_DATE;
/*  IF MS_CONSTANTS.GET_CONSTANT_VALUE('SERVER_NAME')='GSM_CORP' THEN
    IF (NVL(pBALANCE_DATE, SYSDATE)>=TO_DATE('28122011', 'DDMMYYYY'))AND(NVL(pBALANCE_DATE, SYSDATE)<=TO_DATE('01012012', 'DDMMYYYY')) THEN
      vBALANCE_DATE:=TO_DATE('01012012', 'DDMMYYYY');
    END IF;
  END IF;*/
  CALC_BALANCE_ROWS2(pPHONE_NUMBER, DATE_ROWS, COST_ROWS, DESCRIPTION_ROWS, FALSE, vBALANCE_DATE);
  L := COST_ROWS.LAST;
  IF L IS NOT NULL THEN
    FOR I IN COST_ROWS.FIRST..L LOOP
      vRESULT := vRESULT + COST_ROWS(I);
    END LOOP;
  END IF;
  if  pIOT_BALANCE is null then
      IF pBALANCE_DATE IS NULL THEN
        UPDATE IOT_CURRENT_BALANCE CB
          SET CB.BALANCE = vRESULT,
              CB.LAST_UPDATE = SYSDATE,
              CB.UPDATE_TYPE = 2
          WHERE CB.PHONE_NUMBER = pPHONE_NUMBER;
        COMMIT;
      END IF;
  END IF;
  RETURN vRESULT;
END; 