
  CREATE OR REPLACE PROCEDURE "CORP_MOBILE"."CHECK_BILLS" IS
CURSOR C(pPNONE_NUMBER IN VARCHAR2, pCHECK_DATE IN DATE) IS
  SELECT DH.* 
    FROM db_loader_account_phone_hists DH
    WHERE DH.PHONE_NUMBER=pPNONE_NUMBER
      AND DH.BEGIN_DATE<=pCHECK_DATE
      AND DH.END_DATE>=pCHECK_DATE
    ORDER BY DH.END_DATE DESC; 
CURSOR UP(pACCOUNT_ID IN INTEGER, pYEAR_MONTH IN INTEGER, pPHONE_NUMBER IN VARCHAR2) IS
  SELECT DB_A.* 
    FROM DB_LOADER_BILLS_ADD DB_A
    WHERE DB_A.ACCOUNT_ID=pACCOUNT_ID
      AND DB_A.YEAR_MONTH=pYEAR_MONTH
      AND DB_A.PHONE_NUMBER=pPHONE_NUMBER;   
tariff_id_NEW INTEGER;
year_month INTEGER;
CHECK_DATE DATE;
TARIFF_CODE VARCHAR2(50 CHAR);
HIST C%ROWTYPE;
DB_ADD UP%ROWTYPE;
BEGIN
  FOR rec IN(
    SELECT *
      FROM DB_LOADER_BILLS)
  LOOP
    IF rec.BILL_SUM<>0 THEN
      CHECK_DATE:=LAST_DAY (TO_DATE(TO_CHAR(rec.year_month), 'YYYYMM'));
      TARIFF_CODE:='';
      OPEN C(rec.phone_number, CHECK_DATE);
      FETCH C INTO HIST;
      IF C%FOUND THEN
        TARIFF_CODE:=HIST.CELL_PLAN_CODE;
      END IF;
      CLOSE C;    
      tariff_id_NEW:=get_phone_tariff_id(rec.phone_number, TARIFF_CODE, CHECK_DATE);
      OPEN UP(rec.ACCOUNT_ID, rec.YEAR_MONTH, rec.PHONE_NUMBER);
      FETCH UP INTO DB_ADD;
      IF UP%FOUND THEN
        UPDATE DB_LOADER_BILLS_ADD
          SET DB_LOADER_BILLS_ADD.TARIFF_ID=tariff_id_NEW 
          WHERE DB_LOADER_BILLS_ADD.ACCOUNT_ID=rec.ACCOUNT_ID
            AND DB_LOADER_BILLS_ADD.YEAR_MONTH=rec.YEAR_MONTH
            AND DB_LOADER_BILLS_ADD.PHONE_NUMBER=rec.PHONE_NUMBER;
      ELSE
        INSERT INTO DB_LOADER_BILLS_ADD(ACCOUNT_ID, YEAR_MONTH, PHONE_NUMBER, TARIFF_ID, TARIFF_CODE)
          VALUES(rec.ACCOUNT_ID, rec.YEAR_MONTH, rec.PHONE_NUMBER, tariff_id_NEW, TARIFF_CODE);
      END IF;
      CLOSE UP;
      COMMIT;
    END IF;  
  END LOOP;                    
END; 