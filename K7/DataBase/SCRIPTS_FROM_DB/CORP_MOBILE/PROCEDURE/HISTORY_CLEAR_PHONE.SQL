
  CREATE OR REPLACE PROCEDURE "CORP_MOBILE"."HISTORY_CLEAR_PHONE" (
  pPHONE_NUMBER IN VARCHAR2
  ) IS
-- Version = 1  
  CURSOR C1(pEND_DATE IN DATE) IS
    SELECT H.*, ROWID
      FROM DB_LOADER_ACCOUNT_PHONE_HISTS H
      WHERE H.PHONE_NUMBER = pPHONE_NUMBER
        AND H.END_DATE > pEND_DATE
      ORDER BY H.END_DATE ASC;  
  CURSOR C2(pEND_DATE IN DATE) IS
    SELECT H.*, ROWID
      FROM DB_LOADER_ACCOUNT_PHONE_HISTS H
      WHERE H.PHONE_NUMBER = pPHONE_NUMBER
        AND H.END_DATE > pEND_DATE
      ORDER BY H.END_DATE ASC;  
  vDELETE_COMPLETE INTEGER;  
  vDELETE_REQUIRE INTEGER;  
  vD1 C1%ROWTYPE;  
  vD2 C2%ROWTYPE; 
  vSTART_DATE DATE; 
BEGIN
  LOOP
    vSTART_DATE := TO_DATE('01.01.2015', 'DD.MM.YYYY');
    vDELETE_REQUIRE:=0;
    LOOP
      vDELETE_COMPLETE:=0;
      OPEN C1(vSTART_DATE);
      FETCH C1 INTO vD1;
      IF C1%FOUND THEN
        vSTART_DATE:=vD1.END_DATE;
        IF TO_CHAR(vD1.END_DATE, 'HH24:MI:SS') <> '23:59:59' THEN
          OPEN C2(vD1.END_DATE);
          FETCH C2 INTO vD2;
          IF C2%FOUND THEN
            IF vD1.PHONE_NUMBER = vD2.PHONE_NUMBER
                AND vD1.PHONE_IS_ACTIVE = vD2.PHONE_IS_ACTIVE
                AND vD1.CELL_PLAN_CODE = vD2.CELL_PLAN_CODE
                AND vD1.END_DATE > vD2.BEGIN_DATE  -  10/24/60/60 -- Разрыв не более 10 сек
                AND ((NVL(vD1.CONSERVATION, 0) = NVL(vD2.CONSERVATION, 0)) OR (vD2.CONSERVATION IS NULL))
                AND ((NVL(vD1.SYSTEM_BLOCK, 0) = NVL(vD2.SYSTEM_BLOCK, 0)) OR (vD2.SYSTEM_BLOCK IS NULL))
                AND ((NVL(vD1.STATUS_ID, 0) = NVL(vD2.STATUS_ID, 0)) OR (vD2.STATUS_ID IS NULL)) THEN
              -- Отрезки идентичны, нужно соединить.
              DELETE DB_LOADER_ACCOUNT_PHONE_HISTS H
                WHERE H.PHONE_NUMBER = pPHONE_NUMBER
                  AND H.ROWID = vD2.ROWID;
              UPDATE DB_LOADER_ACCOUNT_PHONE_HISTS H
                SET H.END_DATE = vD2.END_DATE
                WHERE H.PHONE_NUMBER = pPHONE_NUMBER
                  AND H.ROWID = vD1.ROWID;
              COMMIT;
              vSTART_DATE:=vD2.END_DATE;
              vDELETE_REQUIRE:=1;
            END IF;
          END IF;
          CLOSE C2;
        END IF;
      ELSE
        vDELETE_COMPLETE:=1;
      END IF;
      CLOSE C1;  
      EXIT WHEN vDELETE_COMPLETE = 1;
    END LOOP;  
    EXIT WHEN vDELETE_REQUIRE = 0;
  END LOOP;
END; 