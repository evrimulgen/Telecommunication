
  CREATE OR REPLACE PROCEDURE "CORP_MOBILE"."NOTICE_PHONE_WITHOUT_CONTR_OLD" IS
-- Version = 3
  CURSOR C IS
    SELECT *
      FROM BLOCK_NO_CONTRACTS_SETTINGS;
  CURSOR N(PHONE IN VARCHAR2) IS
    SELECT *
      FROM NOTICE_PHONE_NO_CONTRACT
      WHERE NOTICE_PHONE_NO_CONTRACT.PHONE_NUMBER = PHONE
        AND NOTICE_PHONE_NO_CONTRACT.DATE_NOTICE > SYSDATE - 15/24/60;
  LOCK_PH VARCHAR2(2000);  
  vDUMMY C%ROWTYPE;
  vNDUMMY N%ROWTYPE;
  ACCESS_DENIED_LIST CLOB;
  NOTICE_LIST DBMS_SQL.VARCHAR2_TABLE;
  I INTEGER;
  J INTEGER;
  SMS_TEXT VARCHAR2(100 CHAR);
  SMS_ITOG VARCHAR2(300 CHAR);
BEGIN
  OPEN C;
  FETCH C INTO vDUMMY;
  CLOSE C;
  ACCESS_DENIED_LIST:=GET_LIST_PHONE_NO_BL_FROM_SYTE;
  I:=0;
  SMS_TEXT:='';
  IF (vDUMMY.CHECK_TIME = 0) 
      OR ((TRUNC(SYSDATE) + vDUMMY.TIME_END/24 > SYSDATE)   --  До скольки утром работать
            OR (TRUNC(SYSDATE) + vDUMMY.TIME_BEGIN/24 < SYSDATE)) THEN  -- До скольки вечером работать
    FOR rec IN(
      SELECT V_ACTIVE_NUMBERS_OUT_CONTRACTS.PHONE_NUMBER,
             ACCOUNTS.ACCOUNT_NUMBER
        FROM V_ACTIVE_NUMBERS_OUT_CONTRACTS,
             ACCOUNTS
        WHERE V_ACTIVE_NUMBERS_OUT_CONTRACTS.ACCOUNT_ID=ACCOUNTS.ACCOUNT_ID(+)
          AND NVL(ACCOUNTS.DO_AUTO_BLOCK, 0) = 1
          AND NOT EXISTS (SELECT 1
                            FROM AUTO_BLOCKED_PHONE_NO_CONTRACT
                            WHERE AUTO_BLOCKED_PHONE_NO_CONTRACT.PHONE_NUMBER = V_ACTIVE_NUMBERS_OUT_CONTRACTS.PHONE_NUMBER
                              AND AUTO_BLOCKED_PHONE_NO_CONTRACT.BLOCK_DATE_TIME > SYSDATE-7/24/60)
          AND NOT EXISTS (SELECT 1
                            FROM PHONE_NUMBER_BLOCK_DENIED
                            WHERE PHONE_NUMBER_BLOCK_DENIED.PHONE_NUMBER = V_ACTIVE_NUMBERS_OUT_CONTRACTS.PHONE_NUMBER))
    LOOP     
      IF DBMS_LOB.INSTR(ACCESS_DENIED_LIST, rec.PHONE_NUMBER) = 0 THEN
        OPEN N(rec.PHONE_NUMBER);
        FETCH N INTO vNDUMMY;
        IF N%NOTFOUND THEN
          I:=I+1;  
          SMS_TEXT:= SMS_TEXT || ' ' || rec.PHONE_NUMBER;
          INSERT INTO NOTICE_PHONE_NO_CONTRACT(PHONE_NUMBER, DATE_NOTICE)
            VALUES(rec.PHONE_NUMBER, SYSDATE);
        END IF; 
        CLOSE N;     
        IF I=6 THEN
          SMS_ITOG:=LOADER3_PCKG.SEND_SMS(vDUMMY.PHONE_FOR_NOTICE, 'AgSv', SMS_TEXT);
--          SMS_ITOG:=LOADER3_PCKG.SEND_SMS('9277401866', 'AgSv', SMS_TEXT);
          I:=0;
          SMS_TEXT:='';
        END IF;  
      END IF;   
    END LOOP; 
    IF I>0 THEN
      SMS_ITOG:=LOADER3_PCKG.SEND_SMS(vDUMMY.PHONE_FOR_NOTICE, 'AgSv', SMS_TEXT);
--      SMS_ITOG:=LOADER3_PCKG.SEND_SMS('9277401866', 'AgSv', SMS_TEXT);
      I:=0;
      SMS_TEXT:='';
    END IF; 
  END IF;  
  COMMIT;
END; 
