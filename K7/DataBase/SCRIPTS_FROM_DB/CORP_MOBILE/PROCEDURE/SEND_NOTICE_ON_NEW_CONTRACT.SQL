
  CREATE OR REPLACE PROCEDURE "CORP_MOBILE"."SEND_NOTICE_ON_NEW_CONTRACT" (pCONTRACT_ID IN INTEGER) IS 
  -- 
  --Version=1 
  CURSOR C IS 
    SELECT CONTRACTS.PHONE_NUMBER_FEDERAL, 
           OPERATORS.OPERATOR_NAME, 
           ABONENTS.SURNAME || ' ' || ABONENTS.NAME || ' ' || 
           ABONENTS.PATRONYMIC FIO, 
           DEALERS.WELCOME_SMS WSMS 
      FROM CONTRACTS, OPERATORS, ABONENTS, DEALERS 
     WHERE CONTRACTS.CONTRACT_ID = pCONTRACT_ID 
       AND CONTRACTS.OPERATOR_ID = OPERATORS.OPERATOR_ID 
       AND CONTRACTS.ABONENT_ID = ABONENTS.ABONENT_ID 
       and CONTRACTS.DEALER_KOD = DEALERS.DEALER_KOD; 
  rec      C%ROWTYPE; 
  SMS_TEXT VARCHAR2(500 CHAR); 
  SMS      VARCHAR2(500 CHAR); 
BEGIN 
  if MS_PARAMS.GET_PARAM_VALUE('SEND_WELCOME_SMS') = '1' then 
   
    OPEN C; 
    FETCH C 
      INTO rec; 
    CLOSE C; 
    IF rec.OPERATOR_NAME = 'Билайн' THEN 
     
      SMS_TEXT := nvl(rec.WSMS, MS_PARAMS.GET_PARAM_VALUE('SEND_TEXT_WELCOME_SMS')); 
      SMS      := LOADER3_PCKG.SEND_SMS(rec.PHONE_NUMBER_FEDERAL, 
                                        'Смс-оповещение', 
                                        SMS_TEXT); 
     
       
      IF SMS IS NULL THEN 
        INSERT INTO BLOCK_SEND_SMS 
          (PHONE_NUMBER, SEND_DATE_TIME, ABONENT_FIO) 
        VALUES 
          (rec.PHONE_NUMBER_FEDERAL, sysdate, rec.FIO); 
      END IF; 
     
      COMMIT; 
    END IF; 
   
  end if; 
 
END; 
