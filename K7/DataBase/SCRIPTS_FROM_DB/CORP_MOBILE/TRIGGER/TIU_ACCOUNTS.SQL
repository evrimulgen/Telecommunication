
  CREATE OR REPLACE TRIGGER "CORP_MOBILE"."TIU_ACCOUNTS" 
--#Version=2 Соколов 19.08.2015 Добавление нового счета в таблицу ACCOUNT_LOADED_BILLS. Вынес создание джобов в процедуру CREATE_JOB_NEW_ACCOUNT.  
BEFORE INSERT OR UPDATE
ON ACCOUNTS 
REFERENCING NEW AS NEW OLD AS OLD
FOR EACH ROW
DECLARE
  PRAGMA AUTONOMOUS_TRANSACTION;
  CURSOR C(AD IN INTEGER) IS
    SELECT *
      FROM ACCOUNT_LOADED_BILLS AB
      WHERE AB.ACCOUNT_ID = AD;
  vDUMMY C%ROWTYPE;
BEGIN
  IF INSERTING THEN
    IF NVL(:NEW.ACCOUNT_ID, 0) = 0 then
      :NEW.ACCOUNT_ID := NEW_ACCOUNT_ID;
    END IF;
    :NEW.USER_CREATED := USER;
    :NEW.DATE_CREATED := SYSDATE;
    -- Добавим JOB 
    CREATE_JOB_NEW_ACCOUNT(:NEW.ACCOUNT_ID, :NEW.PAY_LOAD_INTERVAL, :NEW.LOAD_INTERVAL, 1);
    --    
       OPEN C(:NEW.ACCOUNT_ID);
       FETCH C INTO vDUMMY;
       IF C%NOTFOUND THEN

          INSERT INTO ACCOUNT_LOADED_BILLS (ACCOUNT_ID, YEAR_MONTH, LOAD_BILL_IN_BALANCE)
                                    VALUES (:NEW.ACCOUNT_ID, TO_CHAR(ADD_MONTHS(SYSDATE, -1), 'YYYYMM'), 1);
          COMMIT;                                                  
       END IF;
       CLOSE C;
       
  ELSIF UPDATING THEN
    
   --Изменение атрибутов JOB 
    CREATE_JOB_NEW_ACCOUNT(:NEW.ACCOUNT_ID, :NEW.PAY_LOAD_INTERVAL, :NEW.LOAD_INTERVAL);
    --
  END IF;
  :NEW.USER_LAST_UPDATED := USER;
  :NEW.DATE_LAST_UPDATED := SYSDATE;
END;
ALTER TRIGGER "CORP_MOBILE"."TIU_ACCOUNTS" ENABLE