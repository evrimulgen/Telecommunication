
  CREATE OR REPLACE TRIGGER "CORP_MOBILE"."TU_DB_LDR_RPT_DATA" 
BEFORE UPDATE
ON DB_LOADER_REPORT_DATA
REFERENCING NEW AS NEW OLD AS OLD
FOR EACH ROW
DECLARE
  CURSOR C(pPHONE IN VARCHAR2) IS
    SELECT C.PHONE_NUMBER_FEDERAL,
           C.CURR_TARIFF_ID,
           TR.CALC_KOEFF_DETAL
      FROM CONTRACTS C,
           TARIFFS TR
      WHERE C.PHONE_NUMBER_FEDERAL = pPHONE
        AND NOT EXISTS (SELECT 1
                          FROM CONTRACT_CANCELS CC
                          WHERE C.CONTRACT_ID = CC.CONTRACT_ID)
        AND C.CURR_TARIFF_ID = TR.TARIFF_ID(+)
        AND TR.CALC_KOEFF_DETAL IS NOT NULL;
  DUMMY C%ROWTYPE;
BEGIN
  OPEN C(:NEW.PHONE_NUMBER);
  FETCH C INTO DUMMY;
  IF C%FOUND THEN
    :NEW.DETAIL_SUM:=:NEW.DETAIL_SUM * DUMMY.CALC_KOEFF_DETAL;
  END IF;
  CLOSE C;
  IF UPDATING THEN  
    IF (:new.DETAIL_SUM > :old.DETAIL_SUM) 
        or (TO_NUMBER(TO_CHAR(SYSDATE,'DD')) <=5) THEN
      :new.DATE_LAST_UPDATE := SYSDATE;
      INSERT INTO QUEUE_CURRENT_BALANCES(PHONE_NUMBER, QUEUE_TYPE)
        VALUES(:NEW.PHONE_NUMBER, 43);  
    ELSE
      :new.DETAIL_SUM := :old.DETAIL_SUM;
    END IF;
  END IF;          
END; 
ALTER TRIGGER "CORP_MOBILE"."TU_DB_LDR_RPT_DATA" ENABLE