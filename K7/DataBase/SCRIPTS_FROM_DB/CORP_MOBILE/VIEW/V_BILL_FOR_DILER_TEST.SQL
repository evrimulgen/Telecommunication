
  CREATE OR REPLACE FORCE VIEW "CORP_MOBILE"."V_BILL_FOR_DILER_TEST" ("ACCOUNT_ID", "YEAR_MONTH", "PHONE_NUMBER", "BILL_SUM_ORIGIN", "BILL_SUM", "DISCOUNT_VALUE", "DILER_PAYMENT", "DILER_PAYMENT_FULL", "SUBSCRIBER_PAYMENT_NEW", "SUBSCRIBER_PAYMENT_OLD", "SUBSCRIBER_PAYMENT_ADD_OLD", "OPTION_COST_DILER", "OPTION_COST_DILER_BEELINE", "OPTION_COST_FULL", "TARIFF_NAME", "TAIL", "CHECK_LONG_PLUS_BALANCE", "INSTALLMENT_PAYMENT_SUM", "DILER_SUMM_OLD_MONTH_IN_MINUS") AS 
  SELECT 
-- Version=8
         V.ACCOUNT_ID,
         V.YEAR_MONTH,
         V.PHONE_NUMBER,
         V.BILL_SUM_ORIGIN,
         V.BILL_SUM,
         V.DISCOUNT_VALUE,
         CASE
           WHEN V.BILL_SUM>0 THEN
             LOADER5_PCKG.CALC_DILER_PAYMENT(V.ACCOUNT_ID, V.YEAR_MONTH, V.PHONE_NUMBER, 0)
           ELSE 0
         END AS DILER_PAYMENT,
         CASE
           WHEN V.BILL_SUM>0 THEN
             LOADER5_PCKG.CALC_DILER_PAYMENT(V.ACCOUNT_ID, V.YEAR_MONTH, V.PHONE_NUMBER, 1)
           ELSE 0
         END AS DILER_PAYMENT_FULL,
         V.SUBSCRIBER_PAYMENT_NEW,
         TRUNC(V.SUBSCRIBER_PAYMENT_OLD) SUBSCRIBER_PAYMENT_OLD,
         V.SUBSCRIBER_PAYMENT_ADD_OLD,
         CASE
           WHEN V.BILL_SUM>0 THEN
             LOADER5_PCKG.CALC_OPTION_COST(V.ACCOUNT_ID, V.YEAR_MONTH, V.PHONE_NUMBER, V.TARIFF_ID, 1)
           ELSE 0
         END AS OPTION_COST_DILER, 
         CASE
           WHEN V.BILL_SUM>0 THEN
             LOADER5_PCKG.CALC_OPTION_COST(V.ACCOUNT_ID, V.YEAR_MONTH, V.PHONE_NUMBER, V.TARIFF_ID, 1, 0)
           ELSE 0
         END AS OPTION_COST_DILER_BEELINE, 
         CASE
           WHEN V.BILL_SUM>0 THEN
             LOADER5_PCKG.CALC_OPTION_COST(V.ACCOUNT_ID, V.YEAR_MONTH, V.PHONE_NUMBER, V.TARIFF_ID, 0)
           ELSE 0
         END AS OPTION_COST_FULL,
         T.TARIFF_NAME,
         GET_ABONENT_BALANCE(V.PHONE_NUMBER, LAST_DAY(TO_DATE(V.YEAR_MONTH||'01', 'YYYYMMDD'))) TAIL,
         CASE
           WHEN V.ACCOUNT_ID=1 AND V.YEAR_MONTH<=201002 THEN 0
           ELSE CHECK_LONG_PLUS_BALANCE(V.PHONE_NUMBER, V.YEAR_MONTH)
         END CHECK_LONG_PLUS_BALANCE,        
         CASE
           WHEN V.BILL_SUM>0 THEN
             CASE
               WHEN EXISTS (SELECT 1
                              FROM CONTRACTS C
                              WHERE C.PHONE_NUMBER_FEDERAL = V.PHONE_NUMBER
                                AND NOT EXISTS (SELECT 1
                                                  FROM CONTRACT_CANCELS CC
                                                  WHERE CC.CONTRACT_ID = C.CONTRACT_ID)
                                AND NVL(C.INSTALLMENT_PAYMENT_SUM, 0) > 0 ) THEN
                 LOADER5_PCKG.CALC_INSTALLMENT_DILER(V.YEAR_MONTH, V.PHONE_NUMBER)
               ELSE 0
             END    
           ELSE 0
         END AS INSTALLMENT_PAYMENT_SUM,        
         CASE
           WHEN V.BILL_SUM>0 THEN
             LOADER5_PCKG.CALC_OLD_MONTH_IN_MINUS(V.YEAR_MONTH, V.PHONE_NUMBER)
           ELSE 0
         END AS DILER_SUMM_OLD_MONTH_IN_MINUS
    FROM V_BILL_FOR_CLIENT V,
         TARIFFS T,
         ACCOUNTS AC,
         BILL_FOR_DILER_SAVED DS
    WHERE V.TARIFF_ID=T.TARIFF_ID(+)
      AND V.ACCOUNT_ID=AC.ACCOUNT_ID(+)
      AND AC.DILER_PAYMETS=1
--      AND CHECK_CONTRACTS_BY_YEAR_MONTH(V.PHONE_NUMBER, V.YEAR_MONTH)=1
      AND V.PHONE_NUMBER IN (SELECT CONTRACTS.PHONE_NUMBER_FEDERAL
                               FROM CONTRACTS
                               GROUP BY CONTRACTS.PHONE_NUMBER_FEDERAL)
      AND V.ACCOUNT_ID = DS.ACCOUNT_ID(+)
      AND V.YEAR_MONTH = DS.YEAR_MONTH(+)
      AND V.PHONE_NUMBER = DS.PHONE_NUMBER(+)
      AND DS.PHONE_NUMBER IS NULL 
      AND NOT EXISTS (SELECT 1
                        FROM V_BILL_FINANCE_FOR_CLIENTS VF
                        WHERE VF.ACCOUNT_ID = V.ACCOUNT_ID
                          AND VF.YEAR_MONTH = V.YEAR_MONTH
                          AND VF.PHONE_NUMBER = V.PHONE_NUMBER)                       
  UNION ALL
  SELECT VN.ACCOUNT_ID,
         VN.YEAR_MONTH,
         VN.PHONE_NUMBER,         
         BILL_SUM_ORIGIN,
         BILL_SUM,
         DISCOUNT_VALUE,
         DILER_PAYMENT,
         DILER_PAYMENT_FULL,
         SUBSCRIBER_PAYMENT_NEW,
         SUBSCRIBER_PAYMENT_OLD,
         SUBSCRIBER_PAYMENT_ADD_OLD,
         CASE
           WHEN VN.BILL_SUM>0 THEN
             LOADER5_PCKG.CALC_OPTION_COST(VN.ACCOUNT_ID, VN.YEAR_MONTH, VN.PHONE_NUMBER, VN.TARIFF_ID, 1)
           ELSE 0
         END AS OPTION_COST_DILER, 
         CASE
           WHEN VN.BILL_SUM>0 THEN
             LOADER5_PCKG.CALC_OPTION_COST(VN.ACCOUNT_ID, VN.YEAR_MONTH, VN.PHONE_NUMBER, VN.TARIFF_ID, 1, 0)
           ELSE 0
         END AS OPTION_COST_DILER_BEELINE, 
         CASE
           WHEN VN.BILL_SUM>0 THEN
             LOADER5_PCKG.CALC_OPTION_COST(VN.ACCOUNT_ID, VN.YEAR_MONTH, VN.PHONE_NUMBER, VN.TARIFF_ID, 0)
           ELSE 0
         END AS OPTION_COST_FULL,
         (SELECT T.TARIFF_NAME
            FROM TARIFFS T
            WHERE T.TARIFF_ID = VN.TARIFF_ID) TARIFF_NAME,
         VN.TAIL,
         CHECK_LONG_PLUS_BALANCE,      
         CASE
           WHEN VN.BILL_SUM>0 THEN
             CASE
               WHEN EXISTS (SELECT 1
                              FROM CONTRACTS C
                              WHERE C.PHONE_NUMBER_FEDERAL = VN.PHONE_NUMBER
                                AND NOT EXISTS (SELECT 1
                                                  FROM CONTRACT_CANCELS CC
                                                  WHERE CC.CONTRACT_ID = C.CONTRACT_ID)
                                AND NVL(C.INSTALLMENT_PAYMENT_SUM, 0) > 0 ) THEN
                 LOADER5_PCKG.CALC_INSTALLMENT_DILER(VN.YEAR_MONTH, VN.PHONE_NUMBER)
               ELSE 0
             END    
           ELSE 0
         END AS INSTALLMENT_PAYMENT_SUM,        
         CASE
           WHEN VN.BILL_SUM>0 THEN
             LOADER5_PCKG.CALC_OLD_MONTH_IN_MINUS(VN.YEAR_MONTH, VN.PHONE_NUMBER)
           ELSE 0
         END AS DILER_SUMM_OLD_MONTH_IN_MINUS
    FROM (SELECT V.ACCOUNT_ID,
                 V.YEAR_MONTH,
                 V.PHONE_NUMBER,
                 V.BILL_SUM_OLD BILL_SUM_ORIGIN,
                 V.BILL_SUM_NEW BILL_SUM,
                 V.DISCOUNT_NEW DISCOUNT_VALUE,
                 CASE
                   WHEN V.BILL_SUM_NEW>0 THEN
                     LOADER5_PCKG.CALC_DILER_PAYMENT(V.ACCOUNT_ID, V.YEAR_MONTH, V.PHONE_NUMBER, 0)
                   ELSE 0
                 END AS DILER_PAYMENT,
                 CASE
                   WHEN V.BILL_SUM_NEW>0 THEN
                     LOADER5_PCKG.CALC_DILER_PAYMENT(V.ACCOUNT_ID, V.YEAR_MONTH, V.PHONE_NUMBER, 1)
                   ELSE 0
                 END AS DILER_PAYMENT_FULL,
                 V.ABON_TP_NEW SUBSCRIBER_PAYMENT_NEW,
                 TRUNC(V.ABON_TP_OLD ) SUBSCRIBER_PAYMENT_OLD,
                 V.ABON_ADD_OLD SUBSCRIBER_PAYMENT_ADD_OLD,
                 GET_ABONENT_BALANCE(V.PHONE_NUMBER, LAST_DAY(TO_DATE(V.YEAR_MONTH||'01', 'YYYYMMDD'))) TAIL,
                 CASE
                   WHEN V.ACCOUNT_ID=1 AND V.YEAR_MONTH<=201002 THEN 0
                   ELSE CHECK_LONG_PLUS_BALANCE(V.PHONE_NUMBER, V.YEAR_MONTH)
                 END CHECK_LONG_PLUS_BALANCE,
                 (SELECT AP.TARIFF_ID
                    FROM V_BILL_ABON_PER_FOR_CLIENT AP
                    WHERE AP.ACCOUNT_ID = V.ACCOUNT_ID
                      AND AP.YEAR_MONTH = V.YEAR_MONTH
                      AND AP.PHONE_NUMBER = V.PHONE_NUMBER
                      AND AP.TARIFF_CODE IS NOT NULL
                      AND AP.DATE_END = (SELECT MAX(AP2.DATE_END)
                                           FROM V_BILL_ABON_PER_FOR_CLIENT AP2
                                           WHERE AP2.ACCOUNT_ID = AP.ACCOUNT_ID
                                             AND AP2.YEAR_MONTH = AP.YEAR_MONTH
                                             AND AP2.PHONE_NUMBER = AP.PHONE_NUMBER)
                      AND ROWNUM = 1) TARIFF_ID
            FROM V_BILL_FINANCE_FOR_CLIENTS V,
                 ACCOUNTS AC,
                 BILL_FOR_DILER_SAVED DS
            WHERE V.ACCOUNT_ID=AC.ACCOUNT_ID(+)
              AND AC.DILER_PAYMETS=1
              AND V.ACCOUNT_ID = DS.ACCOUNT_ID(+)
              AND V.YEAR_MONTH = DS.YEAR_MONTH(+)
              AND V.PHONE_NUMBER = DS.PHONE_NUMBER(+)
              AND DS.PHONE_NUMBER IS NULL 
        --      AND CHECK_CONTRACTS_BY_YEAR_MONTH(V.PHONE_NUMBER, V.YEAR_MONTH)=1
              AND V.PHONE_NUMBER IN (SELECT CONTRACTS.PHONE_NUMBER_FEDERAL
                                       FROM CONTRACTS
                                       GROUP BY CONTRACTS.PHONE_NUMBER_FEDERAL)) VN
  UNION ALL
  SELECT DS.ACCOUNT_ID,
         DS.YEAR_MONTH,
         DS.PHONE_NUMBER,
         DS.BILL_SUM_ORIGIN,
         DS.BILL_SUM,     
         DS.DISCOUNT_VALUE,
         DS.DILER_PAYMENT,
         DS.DILER_PAYMENT_FULL,
         DS.SUBSCRIBER_PAYMENT_NEW,
         DS.SUBSCRIBER_PAYMENT_OLD,
         DS.SUBSCRIBER_PAYMENT_ADD_OLD,
         DS.OPTION_COST_DILER, 
         DS.OPTION_COST_DILER_BEELINE, 
         DS.OPTION_COST_FULL,
         DS.TARIFF_NAME,
         DS.TAIL,
         DS.CHECK_LONG_PLUS_BALANCE,
         DS.INSTALLMENT_PAYMENT_SUM,
         DS.DILER_SUMM_OLD_MONTH_IN_MINUS
    FROM BILL_FOR_DILER_SAVED DS 