CREATE OR REPLACE VIEW V_BLOCK_PHONE_WITH_DOPSTATUS AS
--
--#Version=1
--
CREATE OR REPLACE FORCE VIEW CORP_MOBILE.V_BLOCK_PHONE_WITH_DOPSTATUS
AS
   SELECT DB.YEAR_MONTH,
          C.PHONE_NUMBER_FEDERAL PHONE_NUMBER,
          C.DOP_STATUS DOP_STATUS_ID,
          DS.DOP_STATUS_NAME,
          DB.PHONE_IS_ACTIVE,
          ST.ACCESS_UNLOCK,
          ST.ACCESS_BLOCK,
          DB.STATUS_ID,
          ST.COMMENT_CLENT
     FROM V_CONTRACTS C,
          DB_LOADER_ACCOUNT_PHONES DB,
          CONTRACT_DOP_STATUSES DS,
          BEELINE_STATUS_CODE ST
    WHERE     C.PHONE_NUMBER_FEDERAL = DB.PHONE_NUMBER(+)
          AND DB.YEAR_MONTH(+) = TO_NUMBER (TO_CHAR (SYSDATE, 'YYYYMM'))
          AND C.DOP_STATUS = DS.DOP_STATUS_ID(+)
          AND DB.STATUS_ID = ST.STATUS_ID(+)
          AND C.CONTRACT_CANCEL_DATE IS NULL
          AND C.DOP_STATUS IS NOT NULL
          AND DB.CONSERVATION <> 1
          AND ST.IS_SYSTEM_BLOCK <> 1
          AND NVL (DS.DO_BLOCK_PHONE, 0) <> 0 --только номера с доп статусами, по которым разрешено блокировать
          AND ( ( (ST.IS_ACTIVE <> 1) AND (ST.ACCESS_UNLOCK = 1))
               OR ( (ST.IS_ACTIVE = 1) AND (ST.ACCESS_BLOCK = 1)));
/

--GRANT SELECT ON V_BLOCK_PHONE_WITH_DOPSTATUS TO CORP_MOBILE_ROLE;

--GRANT SELECT ON V_BLOCK_PHONE_WITH_DOPSTATUS TO CORP_MOBILE_ROLE_RO;