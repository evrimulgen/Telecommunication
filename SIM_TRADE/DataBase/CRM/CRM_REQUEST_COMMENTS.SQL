CREATE TABLE CRM_REQUEST_COMMENTS(
  COMMENT_ID INTEGER,
  REQUEST_ID INTEGER,
  TEXT_COMMENT LONG,
  DATE_CREATED DATE,
  USER_CREATED       VARCHAR2(30 CHAR),
  USER_LAST_UPDATED  VARCHAR2(30 CHAR),
  DATE_LAST_UPDATED  DATE);

CREATE SEQUENCE S_NEW_COMMENT_ID;

CREATE OR REPLACE TRIGGER TIU_CRM_RQT_CMNTS
  BEFORE INSERT OR UPDATE ON CRM_REQUEST_COMMENTS FOR EACH ROW
--#Version=1
BEGIN
  IF INSERTING THEN
    IF NVL(:NEW.COMMENT_ID, 0) = 0 then
      :NEW.COMMENT_ID := S_NEW_COMMENT_ID.NEXTVAL;
    END IF;
  END IF;
  :NEW.DATE_LAST_UPDATED:=SYSDATE;
END;

ALTER TABLE CRM_REQUEST_COMMENTS DROP CONSTRAINT K_CRM_COMMENT;

ALTER TABLE CRM_REQUEST_COMMENTS ADD 
CONSTRAINT K_CRM_COMMENT
 FOREIGN KEY (REQUEST_ID)
 REFERENCES CRM_REQUESTS (REQUEST_ID)
 ON DELETE CASCADE
 ENABLE
 VALIDATE;

GRANT SELECT, INSERT, DELETE, UPDATE ON CRM_REQUEST_COMMENTS TO CRM_USER;
CREATE SYNONYM CRM_USER.REQUEST_COMMENTS FOR CRM_REQUEST_COMMENTS;

