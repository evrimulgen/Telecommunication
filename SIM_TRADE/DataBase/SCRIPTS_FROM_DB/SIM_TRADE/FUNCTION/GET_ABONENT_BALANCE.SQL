
  CREATE OR REPLACE FUNCTION "SIM_TRADE"."GET_ABONENT_BALANCE" (
  pPHONE_NUMBER IN VARCHAR2,
  pBALANCE_DATE IN DATE DEFAULT NULL
  ) RETURN NUMBER IS
--#Version=2
  DATE_ROWS DBMS_SQL.DATE_TABLE; 
  COST_ROWS DBMS_SQL.NUMBER_TABLE; 
  DESCRIPTION_ROWS DBMS_SQL.VARCHAR2_TABLE;
  vRESULT NUMBER(15, 2);
  L BINARY_INTEGER;
BEGIN
  vRESULT := 0;
  CALC_BALANCE_ROWS2(pPHONE_NUMBER, DATE_ROWS, COST_ROWS, DESCRIPTION_ROWS, FALSE, pBALANCE_DATE);
  L := COST_ROWS.LAST;
  IF L IS NOT NULL THEN
    FOR I IN COST_ROWS.FIRST..L LOOP
      vRESULT := vRESULT + COST_ROWS(I);
    END LOOP;
  END IF;
  RETURN vRESULT;
END; 