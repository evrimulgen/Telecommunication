
  CREATE OR REPLACE FUNCTION "SIM_TRADE"."PROG_SELECT_CONTRACT" (
  pPHONE_NUMBER IN VARCHAR2
  ) RETURN INTEGER IS
  CURSOR C IS 
    SELECT C1.CONTRACT_ID,
           CC1.CONTRACT_CANCEL_DATE
      FROM CONTRACTS C1,
           CONTRACT_CANCELS CC1
      WHERE C1.PHONE_NUMBER_FEDERAL=pPHONE_NUMBER
        AND C1.CONTRACT_ID=CC1.CONTRACT_ID(+)
      ORDER BY C1.CONTRACT_DATE DESC;
  C_DUMMY C%ROWTYPE;   
  CURSOR PH IS
    SELECT PH1.PHONE_NUMBER
      FROM DB_LOADER_ACCOUNT_PHONES PH1
      WHERE PH1.PHONE_NUMBER=pPHONE_NUMBER
        AND PH1.YEAR_MONTH=(SELECT MAX(PH2.YEAR_MONTH)
                              FROM DB_LOADER_ACCOUNT_PHONES PH2);
  PH_DUMMY PH%ROWTYPE;   
  vCONTRACT_ID INTEGER;    
BEGIN  
  OPEN C;
  FETCH C INTO C_DUMMY;
  IF C%FOUND THEN
    vCONTRACT_ID:=C_DUMMY.CONTRACT_ID;
  ELSE
    OPEN PH;
    FETCH PH INTO PH_DUMMY;
    IF PH%FOUND THEN
      vCONTRACT_ID:=0;
    ELSE
      vCONTRACT_ID:=-1;
    END IF;
    CLOSE PH;
  END IF;
  CLOSE C;
  RETURN vCONTRACT_ID;
END;  

--grant execute on PROG_SELECT_CONTRACT to corp_mobile_role;

--grant execute on PROG_SELECT_CONTRACT to corp_mobile_role_ro; 