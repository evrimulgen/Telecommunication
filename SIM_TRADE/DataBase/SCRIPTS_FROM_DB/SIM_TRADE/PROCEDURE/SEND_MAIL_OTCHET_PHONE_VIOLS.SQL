
  CREATE OR REPLACE PROCEDURE "SIM_TRADE"."SEND_MAIL_OTCHET_PHONE_VIOLS" IS
--Version=1
TEXT CLOB;
BEGIN
  TEXT:=GET_MAIL_PHONE_VIOLATIONS(TO_NUMBER(TO_CHAR(SYSDATE, 'YYYYMM')));
  FOR rec IN(
    SELECT REPORT_MAIL_RECIPIENTS.MAIL_ADRESS,
           REPORT_TYPES.REPORT_NAME
      FROM REPORT_MAIL_RECIPIENTS, REPORT_TYPES
      WHERE REPORT_MAIL_RECIPIENTS.TYPE_REPORT='CONTROL_PHONE_NUMBERS'
         AND REPORT_MAIL_RECIPIENTS.TYPE_REPORT=REPORT_TYPES.TYPE_REPORT 
  ) LOOP
    IF TEXT IS NULL THEN
      SEND_MAIL(rec.MAIL_ADRESS,rec.REPORT_NAME || ' на ' || TO_CHAR(SYSDATE, 'DD.MM.YYYY'), 'Нарушений нет');
    ELSE
      SEND_MAIL(rec.MAIL_ADRESS,rec.REPORT_NAME || ' на ' || TO_CHAR(SYSDATE, 'DD.MM.YYYY'), TEXT);
    END IF;
  END LOOP;     
END; 