
  CREATE OR REPLACE TRIGGER "SIM_TRADE"."TIU_CONTRACT_CHANGES" 
  BEFORE INSERT OR UPDATE ON CONTRACT_CHANGES FOR EACH ROW
--#Version=1
DECLARE
vPHONE_NUMBER VARCHAR2(10 CHAR);
vSTART INTEGER;
vEND INTEGER;
BEGIN
  SELECT C.PHONE_NUMBER_FEDERAL INTO vPHONE_NUMBER
    FROM CONTRACTS C
    WHERE C.CONTRACT_ID = :NEW.CONTRACT_ID; 
  IF INSERTING THEN
    IF NVL(:NEW.CONTRACT_CHANGE_ID, 0) = 0 then
      :NEW.CONTRACT_CHANGE_ID := NEW_CONTRACT_CHANGE_ID;
    END IF;
    :NEW.USER_CREATED := USER;
    :NEW.DATE_CREATED := SYSDATE;
  END IF;
  vSTART:=TO_NUMBER(TO_CHAR(:NEW.CONTRACT_CHANGE_DATE, 'YYYYMM'));
  vEND:=TO_NUMBER(TO_CHAR(SYSDATE, 'YYYYMM'));
  FOR I IN TRUNC(vSTART/100)..TRUNC(vEND/100) 
  LOOP
    FOR J IN 1..12 
    LOOP
      IF (I*100 + J >= vSTART) AND (I*100 + J <= vEND) THEN
        INSERT INTO QUEUE_ABONENT_PER_REBILD(YEAR_MONTH, PHONE_NUMBER)
          VALUES(I*100 + J, vPHONE_NUMBER);
      END IF;
    END LOOP;
  END LOOP;
  :NEW.USER_LAST_UPDATED := USER;
  :NEW.DATE_LAST_UPDATED := SYSDATE;
END; 
ALTER TRIGGER "SIM_TRADE"."TIU_CONTRACT_CHANGES" ENABLE