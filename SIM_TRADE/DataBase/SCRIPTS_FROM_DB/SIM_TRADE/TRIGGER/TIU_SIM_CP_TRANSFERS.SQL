
  CREATE OR REPLACE TRIGGER "SIM_TRADE"."TIU_SIM_CP_TRANSFERS" 
  BEFORE INSERT OR UPDATE ON SIM_CP_TRANSFERS FOR EACH ROW
--#Version=5
DECLARE
  PRAGMA AUTONOMOUS_TRANSACTION;
BEGIN
  IF INSERTING THEN
    IF NVL(:NEW.TRANSFER_ID, 0) = 0 then
      :NEW.TRANSFER_ID := NEW_TRANSFER_ID;
    END IF;
    :NEW.USER_CREATED:=USER;
    :NEW.DATE_CREATED:=SYSDATE;
    :NEW.DATE_BEGIN:=SYSDATE;
  END IF;
  IF UPDATING THEN
    IF INSTR(:NEW.RESULTAT, 'Перевод успешно выполнен')>0 then
      :NEW.TRANSFERED_SUM:=:NEW.TRANSFER_SUM;
    ELSE
      IF INSTR(:NEW.RESULTAT, 'Переведен остаток:')>0 then
        :NEW.TRANSFERED_SUM:=TO_NUMBER(REPLACE(REPLACE(:NEW.RESULTAT, 'Переведен остаток: '),'.',','));
      ELSE
        :NEW.TRANSFERED_SUM:=0;
      END IF;    
    END IF;
  END IF;
  :NEW.USER_LAST_UPDATED:=USER;
  :NEW.DATE_LAST_UPDATED:=SYSDATE;
END; 

ALTER TRIGGER "SIM_TRADE"."TIU_SIM_CP_TRANSFERS" ENABLE