
  CREATE OR REPLACE FORCE VIEW "SIM_TRADE"."V_FULL_BALANCE_BILLS2" ("PHONE_NUMBER", "BILL_DATE", "BILL_SUM", "REMARK") AS 
  SELECT
--
--#Version=1
--
  DB_LOADER_BILLS.PHONE_NUMBER,
  DB_LOADER_BILLS.DATE_END AS BILL_DATE,
  TRUNC(
    DB_LOADER_BILLS.BILL_SUM + DB_LOADER_BILLS.SUBSCRIBER_PAYMENT_MAIN*
    (NVL((
      SELECT DECODE(TR.CALC_KOEFF, NULL, 1, 0, 1, TR.CALC_KOEFF)  
      FROM DB_LOADER_ACCOUNT_PHONES DP, TARIFFS TR
      WHERE DP.PHONE_NUMBER = DB_LOADER_BILLS.PHONE_NUMBER
        AND DP.YEAR_MONTH = DB_LOADER_BILLS.YEAR_MONTH
        AND DP.CELL_PLAN_CODE = TR.TARIFF_CODE
        AND ROWNUM < 2
    ), 1) - 1) 
  , 2) AS BILL_SUM,
  'Счёт оператора с '||TO_CHAR(DB_LOADER_BILLS.DATE_BEGIN, 'DD.MM.YYYY') 
  || ' по ' || TO_CHAR(DB_LOADER_BILLS.DATE_END, 'DD.MM.YYYY') AS REMARK
  FROM
  DB_LOADER_BILLS
  UNION ALL
  SELECT
  DB_LOADER_PHONE_STAT.PHONE_NUMBER,
  TRUNC(DB_LOADER_PHONE_STAT.LAST_CHECK_DATE_TIME) AS BILL_DATE,
  DB_LOADER_PHONE_STAT.ESTIMATE_SUM AS BILL_SUM,
  'Детализация звонков за '
  || LOWER(TO_CHAR(TO_DATE(DB_LOADER_PHONE_STAT.YEAR_MONTH, 'YYYYMM'), 'MM.YYYY')) 
  || ' (на ' || TO_CHAR(DB_LOADER_PHONE_STAT.LAST_CHECK_DATE_TIME, 'DD.MM.YYYY HH24:MI')|| ')'
  FROM
  DB_LOADER_PHONE_STAT
  WHERE NOT EXISTS(
    SELECT 1 FROM DB_LOADER_BILLS 
    WHERE DB_LOADER_BILLS.PHONE_NUMBER=DB_LOADER_PHONE_STAT.PHONE_NUMBER
    AND DB_LOADER_BILLS.YEAR_MONTH=DB_LOADER_PHONE_STAT.YEAR_MONTH
    ) 