
  CREATE OR REPLACE FORCE VIEW "SIM_TRADE"."V_PROFIT_BY_PHONES" ("ACCOUNT_ID", "YEAR_MONTH", "PHONE_NUMBER", "OPERATOR_BILL_SUM", "CLIENT_BILL_SUM", "PROFIT_SUM") AS 
  SELECT DB_LOADER_BILLS.ACCOUNT_ID,
       DB_LOADER_BILLS.YEAR_MONTH,
       DB_LOADER_BILLS.PHONE_NUMBER,
       CASE 
         WHEN DB_LOADER_BILLS.BILL_SUM<0 THEN 0
         ELSE DB_LOADER_BILLS.BILL_SUM
       END AS OPERATOR_BILL_SUM,
       CASE
         WHEN DB_LOADER_BILLS.BILL_SUM<0 THEN 0
         ELSE V_BILL_FOR_CLIENT.BILL_SUM
       END AS CLIENT_BILL_SUM,
       CASE
         WHEN DB_LOADER_BILLS.BILL_SUM<0 THEN 0
         ELSE V_BILL_FOR_CLIENT.BILL_SUM - DB_LOADER_BILLS.BILL_SUM
       END AS PROFIT_SUM
  FROM DB_LOADER_BILLS,
       V_BILL_FOR_CLIENT
  WHERE DB_LOADER_BILLS.PHONE_NUMBER=V_BILL_FOR_CLIENT.PHONE_NUMBER
    AND DB_LOADER_BILLS.YEAR_MONTH=V_BILL_FOR_CLIENT.YEAR_MONTH
    AND 0 <> V_BILL_FOR_CLIENT.BILL_SUM - DB_LOADER_BILLS.BILL_SUM
    AND (DB_LOADER_BILLS.PHONE_NUMBER, DB_LOADER_BILLS.YEAR_MONTH) in 
      (SELECT PHONE_NUMBER, YEAR_MONTH
         FROM DB_LOADER_PHONE_STAT
         WHERE (ZEROCOST_OUTCOME_MINUTES <> 0)
           OR (CALLS_COUNT <> 0)
           OR (CALLS_COST <> 0)
           OR (SMS_COUNT <> 0)
           OR (MMS_COUNT <> 0)
           OR (INTERNET_MB <> 0)) 